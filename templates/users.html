{% extends "base.html" %}

{% block title %}Пользователи - VideoBot Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-users me-2"></i>
        Управление пользователями
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-outline-primary btn-custom" onclick="refreshUsers()">
                <i class="fas fa-sync-alt me-2"></i>
                Обновить
            </button>
            <button type="button" class="btn btn-outline-success btn-custom" onclick="exportUsers()">
                <i class="fas fa-download me-2"></i>
                Экспорт
            </button>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="searchInput" class="form-label">Поиск</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" placeholder="ID, имя пользователя...">
                </div>
            </div>
            <div class="col-md-3">
                <label for="statusFilter" class="form-label">Статус</label>
                <select class="form-select" id="statusFilter">
                    <option value="">Все пользователи</option>
                    <option value="active">Активные</option>
                    <option value="banned">Заблокированные</option>
                    <option value="admin">Администраторы</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="activityFilter" class="form-label">Активность</label>
                <select class="form-select" id="activityFilter">
                    <option value="">Все время</option>
                    <option value="24h">За 24 часа</option>
                    <option value="7d">За 7 дней</option>
                    <option value="30d">За 30 дней</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="button" class="btn btn-primary btn-custom" onclick="applyFilters()">
                        <i class="fas fa-filter me-2"></i>
                        Применить
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-list me-2"></i>
            Список пользователей
        </h5>
        <span class="badge bg-primary badge-status" id="userCount">0 пользователей</span>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="usersTable">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" class="form-check-input" id="selectAll">
                        </th>
                        <th>ID</th>
                        <th>Имя</th>
                        <th>Username</th>
                        <th>Регистрация</th>
                        <th>Последняя активность</th>
                        <th>Видео</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="9" class="text-center">
                            <div class="loading"></div>
                            Загрузка пользователей...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="Навигация по страницам" class="mt-3">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination будет добавлена через JavaScript -->
            </ul>
        </nav>
    </div>
</div>

<!-- Bulk Actions -->
<div class="card mt-3" id="bulkActions" style="display: none;">
    <div class="card-body">
        <div class="d-flex align-items-center">
            <span class="me-3">
                <strong id="selectedCount">0</strong> пользователей выбрано
            </span>
            <div class="btn-group">
                <button type="button" class="btn btn-warning btn-sm" onclick="bulkBan()">
                    <i class="fas fa-ban me-1"></i>
                    Заблокировать
                </button>
                <button type="button" class="btn btn-success btn-sm" onclick="bulkUnban()">
                    <i class="fas fa-check me-1"></i>
                    Разблокировать
                </button>
                <button type="button" class="btn btn-info btn-sm" onclick="bulkMakeAdmin()">
                    <i class="fas fa-user-shield me-1"></i>
                    Сделать админом
                </button>
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user me-2"></i>
                    Информация о пользователе
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userModalBody">
                <!-- Содержимое будет загружено через JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let totalPages = 1;
let selectedUsers = new Set();

$(document).ready(function() {
    loadUsers();
    
    // Обработчики событий
    $('#searchInput').on('input', debounce(applyFilters, 500));
    $('#selectAll').on('change', toggleSelectAll);
});

function loadUsers(page = 1) {
    const params = new URLSearchParams({
        page: page,
        search: $('#searchInput').val(),
        status: $('#statusFilter').val(),
        activity: $('#activityFilter').val()
    });
    
    $.get(`/api/users?${params}`)
        .done(function(response) {
            if (response.success) {
                updateUsersTable(response.data.users);
                updatePagination(response.data.pagination);
                $('#userCount').text(`${response.data.pagination.total} пользователей`);
            }
        })
        .fail(function() {
            showError('Ошибка загрузки пользователей');
        });
}

function updateUsersTable(users) {
    const tbody = $('#usersTable tbody');
    tbody.empty();
    
    if (users.length === 0) {
        tbody.append('<tr><td colspan="9" class="text-center text-muted">Пользователи не найдены</td></tr>');
        return;
    }
    
    users.forEach(user => {
        const statusBadge = getStatusBadge(user);
        const adminBadge = user.is_admin ? '<span class="badge bg-info badge-status ms-1">Admin</span>' : '';
        
        const row = `
            <tr data-user-id="${user.user_id}">
                <td>
                    <input type="checkbox" class="form-check-input user-checkbox" value="${user.user_id}">
                </td>
                <td><code>${user.user_id}</code></td>
                <td>
                    <a href="#" onclick="showUserDetails(${user.user_id})" class="text-decoration-none">
                        ${user.first_name || 'Не указано'}
                    </a>
                </td>
                <td>${user.username ? '@' + user.username : '-'}</td>
                <td>${formatDateTime(user.created_at)}</td>
                <td>${user.last_activity ? formatDateTime(user.last_activity) : 'Никогда'}</td>
                <td><span class="badge bg-info badge-status">${user.video_count || 0}</span></td>
                <td>${statusBadge}${adminBadge}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm" onclick="showUserDetails(${user.user_id})" title="Подробности">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${user.is_banned ? 
                            `<button class="btn btn-outline-success btn-sm" onclick="unbanUser(${user.user_id})" title="Разблокировать">
                                <i class="fas fa-check"></i>
                            </button>` :
                            `<button class="btn btn-outline-warning btn-sm" onclick="banUser(${user.user_id})" title="Заблокировать">
                                <i class="fas fa-ban"></i>
                            </button>`
                        }
                        ${!user.is_admin ? 
                            `<button class="btn btn-outline-info btn-sm" onclick="makeAdmin(${user.user_id})" title="Сделать админом">
                                <i class="fas fa-user-shield"></i>
                            </button>` : ''
                        }
                    </div>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
    
    // Обновляем обработчики чекбоксов
    $('.user-checkbox').on('change', updateSelectedUsers);
}

function getStatusBadge(user) {
    if (user.is_banned) {
        return '<span class="badge bg-danger badge-status">Заблокирован</span>';
    }
    
    const lastActivity = new Date(user.last_activity);
    const now = new Date();
    const hoursDiff = (now - lastActivity) / (1000 * 60 * 60);
    
    if (hoursDiff <= 24) {
        return '<span class="badge bg-success badge-status">Активен</span>';
    } else if (hoursDiff <= 168) { // 7 дней
        return '<span class="badge bg-warning badge-status">Неактивен</span>';
    } else {
        return '<span class="badge bg-secondary badge-status">Давно не был</span>';
    }
}

function updatePagination(pagination) {
    currentPage = pagination.current_page;
    totalPages = pagination.total_pages;
    
    const paginationEl = $('#pagination');
    paginationEl.empty();
    
    if (totalPages <= 1) return;
    
    // Предыдущая страница
    const prevDisabled = currentPage === 1 ? 'disabled' : '';
    paginationEl.append(`
        <li class="page-item ${prevDisabled}">
            <a class="page-link" href="#" onclick="loadUsers(${currentPage - 1})">Предыдущая</a>
        </li>
    `);
    
    // Страницы
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const active = i === currentPage ? 'active' : '';
        paginationEl.append(`
            <li class="page-item ${active}">
                <a class="page-link" href="#" onclick="loadUsers(${i})">${i}</a>
            </li>
        `);
    }
    
    // Следующая страница
    const nextDisabled = currentPage === totalPages ? 'disabled' : '';
    paginationEl.append(`
        <li class="page-item ${nextDisabled}">
            <a class="page-link" href="#" onclick="loadUsers(${currentPage + 1})">Следующая</a>
        </li>
    `);
}

function applyFilters() {
    currentPage = 1;
    selectedUsers.clear();
    updateBulkActions();
    loadUsers();
}

function refreshUsers() {
    loadUsers(currentPage);
}

function toggleSelectAll() {
    const isChecked = $('#selectAll').is(':checked');
    $('.user-checkbox').prop('checked', isChecked);
    updateSelectedUsers();
}

function updateSelectedUsers() {
    selectedUsers.clear();
    $('.user-checkbox:checked').each(function() {
        selectedUsers.add($(this).val());
    });
    updateBulkActions();
}

function updateBulkActions() {
    const count = selectedUsers.size;
    $('#selectedCount').text(count);
    
    if (count > 0) {
        $('#bulkActions').show();
    } else {
        $('#bulkActions').hide();
    }
}

function showUserDetails(userId) {
    $.get(`/api/user/${userId}`)
        .done(function(response) {
            if (response.success) {
                const user = response.data;
                const modalBody = $('#userModalBody');
                
                modalBody.html(`
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Основная информация</h6>
                            <table class="table table-sm">
                                <tr><td><strong>ID:</strong></td><td><code>${user.user_id}</code></td></tr>
                                <tr><td><strong>Имя:</strong></td><td>${user.first_name || 'Не указано'}</td></tr>
                                <tr><td><strong>Фамилия:</strong></td><td>${user.last_name || 'Не указано'}</td></tr>
                                <tr><td><strong>Username:</strong></td><td>${user.username ? '@' + user.username : 'Не указано'}</td></tr>
                                <tr><td><strong>Язык:</strong></td><td>${user.language_code || 'Не указано'}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Статистика</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Регистрация:</strong></td><td>${formatDateTime(user.created_at)}</td></tr>
                                <tr><td><strong>Последняя активность:</strong></td><td>${user.last_activity ? formatDateTime(user.last_activity) : 'Никогда'}</td></tr>
                                <tr><td><strong>Видео обработано:</strong></td><td>${user.video_count || 0}</td></tr>
                                <tr><td><strong>Статус:</strong></td><td>${getStatusBadge(user)}</td></tr>
                                <tr><td><strong>Администратор:</strong></td><td>${user.is_admin ? 'Да' : 'Нет'}</td></tr>
                            </table>
                        </div>
                    </div>
                `);
                
                $('#userModal').modal('show');
            }
        })
        .fail(function() {
            showError('Ошибка загрузки информации о пользователе');
        });
}

function banUser(userId) {
    if (!confirm('Вы уверены, что хотите заблокировать этого пользователя?')) return;
    
    $.post('/api/ban_user', { user_id: userId })
        .done(function(response) {
            if (response.success) {
                showSuccess('Пользователь заблокирован');
                loadUsers(currentPage);
            } else {
                showError(response.message || 'Ошибка блокировки пользователя');
            }
        })
        .fail(function() {
            showError('Ошибка блокировки пользователя');
        });
}

function unbanUser(userId) {
    $.post('/api/unban_user', { user_id: userId })
        .done(function(response) {
            if (response.success) {
                showSuccess('Пользователь разблокирован');
                loadUsers(currentPage);
            } else {
                showError(response.message || 'Ошибка разблокировки пользователя');
            }
        })
        .fail(function() {
            showError('Ошибка разблокировки пользователя');
        });
}

function makeAdmin(userId) {
    if (!confirm('Вы уверены, что хотите назначить этого пользователя администратором?')) return;
    
    $.post('/api/make_admin', { user_id: userId })
        .done(function(response) {
            if (response.success) {
                showSuccess('Пользователь назначен администратором');
                loadUsers(currentPage);
            } else {
                showError(response.message || 'Ошибка назначения администратора');
            }
        })
        .fail(function() {
            showError('Ошибка назначения администратора');
        });
}

function bulkBan() {
    if (selectedUsers.size === 0) return;
    if (!confirm(`Вы уверены, что хотите заблокировать ${selectedUsers.size} пользователей?`)) return;
    
    const userIds = Array.from(selectedUsers);
    $.post('/api/bulk_ban', { user_ids: userIds })
        .done(function(response) {
            if (response.success) {
                showSuccess(`Заблокировано ${response.data.affected} пользователей`);
                selectedUsers.clear();
                updateBulkActions();
                loadUsers(currentPage);
            } else {
                showError(response.message || 'Ошибка массовой блокировки');
            }
        })
        .fail(function() {
            showError('Ошибка массовой блокировки');
        });
}

function bulkUnban() {
    if (selectedUsers.size === 0) return;
    
    const userIds = Array.from(selectedUsers);
    $.post('/api/bulk_unban', { user_ids: userIds })
        .done(function(response) {
            if (response.success) {
                showSuccess(`Разблокировано ${response.data.affected} пользователей`);
                selectedUsers.clear();
                updateBulkActions();
                loadUsers(currentPage);
            } else {
                showError(response.message || 'Ошибка массовой разблокировки');
            }
        })
        .fail(function() {
            showError('Ошибка массовой разблокировки');
        });
}

function bulkMakeAdmin() {
    if (selectedUsers.size === 0) return;
    if (!confirm(`Вы уверены, что хотите назначить ${selectedUsers.size} пользователей администраторами?`)) return;
    
    const userIds = Array.from(selectedUsers);
    $.post('/api/bulk_make_admin', { user_ids: userIds })
        .done(function(response) {
            if (response.success) {
                showSuccess(`Назначено ${response.data.affected} администраторов`);
                selectedUsers.clear();
                updateBulkActions();
                loadUsers(currentPage);
            } else {
                showError(response.message || 'Ошибка массового назначения');
            }
        })
        .fail(function() {
            showError('Ошибка массового назначения');
        });
}

function exportUsers() {
    const params = new URLSearchParams({
        search: $('#searchInput').val(),
        status: $('#statusFilter').val(),
        activity: $('#activityFilter').val()
    });
    
    window.open(`/api/export_users?${params}`, '_blank');
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        timeZone: 'Europe/Moscow'
    });
}

function showError(message) {
    const alert = `
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    $('.main-content .pt-3').prepend(alert);
}

function showSuccess(message) {
    const alert = `
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    $('.main-content .pt-3').prepend(alert);
}
</script>
{% endblock %}